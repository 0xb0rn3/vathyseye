#!/usr/bin/env bash

#############################################################################
# VathysEye 5.1 
# Author: 0xb0rn3 | 0xbv1
# Description: Complete setup with dependency management and optimization
#############################################################################

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
RESET='\033[0m'

INSTALL_DIR="/usr/local/bin"
VATHYS_HOME="${HOME}/.vathyseye"
SCRIPT_VERSION="5.1.0"
OS_TYPE=""
PACKAGE_MANAGER=""

# Detect OS and package manager
detect_system() {
    if [[ -f /etc/os-release ]]; then
        . /etc/os-release
        OS_TYPE="$ID"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS_TYPE="macos"
    else
        OS_TYPE="unknown"
    fi
    
    # Detect package manager
    if command -v apt-get >/dev/null 2>&1; then
        PACKAGE_MANAGER="apt"
    elif command -v yum >/dev/null 2>&1; then
        PACKAGE_MANAGER="yum"
    elif command -v dnf >/dev/null 2>&1; then
        PACKAGE_MANAGER="dnf"
    elif command -v pacman >/dev/null 2>&1; then
        PACKAGE_MANAGER="pacman"
    elif command -v brew >/dev/null 2>&1; then
        PACKAGE_MANAGER="brew"
    elif command -v zypper >/dev/null 2>&1; then
        PACKAGE_MANAGER="zypper"
    else
        PACKAGE_MANAGER="unknown"
    fi
}

echo -e "${BOLD}${CYAN}"
cat << "EOF"
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        VathysEye 5.1                              โ
โ          Ultimate CLI File Manager + SSH/SFTP Client              โ
โ       NEW: Mass Copy with Exclusions + Auto-Update System         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
EOF
echo -e "${RESET}"

detect_system
echo -e "${CYAN}๐ Detected System: ${BOLD}${OS_TYPE}${RESET}"
echo -e "${CYAN}๐ฆ Package Manager: ${BOLD}${PACKAGE_MANAGER}${RESET}\n"

# Check for required dependencies
check_dependencies() {
    echo -e "${BOLD}${YELLOW}[1/9] Checking dependencies...${RESET}"
    
    local missing_required=()
    local missing_optional=()
    local missing_recommended=()
    
    # Critical dependencies
    command -v gcc >/dev/null 2>&1 || missing_required+=("gcc")
    command -v make >/dev/null 2>&1 || missing_required+=("make")
    command -v tar >/dev/null 2>&1 || missing_required+=("tar")
    command -v find >/dev/null 2>&1 || missing_required+=("findutils")
    command -v ssh >/dev/null 2>&1 || missing_required+=("openssh-client")
    command -v scp >/dev/null 2>&1 || missing_required+=("openssh-client")
    
    # Recommended for full functionality
    command -v rsync >/dev/null 2>&1 || missing_recommended+=("rsync")
    command -v zip >/dev/null 2>&1 || missing_recommended+=("zip")
    command -v unzip >/dev/null 2>&1 || missing_recommended+=("unzip")
    command -v gzip >/dev/null 2>&1 || missing_recommended+=("gzip")
    command -v bzip2 >/dev/null 2>&1 || missing_recommended+=("bzip2")
    command -v xz >/dev/null 2>&1 || missing_recommended+=("xz-utils")
    command -v numfmt >/dev/null 2>&1 || missing_recommended+=("coreutils")
    command -v curl >/dev/null 2>&1 || missing_recommended+=("curl")
    
    # Optional but useful
    command -v 7z >/dev/null 2>&1 || missing_optional+=("p7zip-full")
    command -v unrar >/dev/null 2>&1 || missing_optional+=("unrar")
    command -v pv >/dev/null 2>&1 || missing_optional+=("pv")
    command -v wget >/dev/null 2>&1 || missing_optional+=("wget")
    
    # Handle missing required dependencies
    if [[ ${#missing_required[@]} -gt 0 ]]; then
        echo -e "${RED}โ Missing required dependencies: ${missing_required[*]}${RESET}"
        echo -e "${YELLOW}๐ฆ Attempting to install required packages...${RESET}\n"
        
        if ! install_packages "${missing_required[@]}"; then
            echo -e "${RED}โ Failed to install required dependencies${RESET}"
            echo -e "${YELLOW}Please install manually:${RESET}"
            show_install_commands "${missing_required[@]}"
            exit 1
        fi
    else
        echo -e "${GREEN}โ All required dependencies found${RESET}"
    fi
    
    # Handle recommended dependencies
    if [[ ${#missing_recommended[@]} -gt 0 ]]; then
        echo -e "${YELLOW}โ๏ธ  Missing recommended packages: ${missing_recommended[*]}${RESET}"
        echo -e "${CYAN}   (Highly recommended for mass copy and auto-update features)${RESET}"
        echo -en "${CYAN}Install recommended packages? (Y/n): ${RESET}"
        read -r response
        
        if [[ ! "$response" =~ ^[Nn]$ ]]; then
            install_packages "${missing_recommended[@]}"
        fi
    fi
    
    # Handle optional dependencies
    if [[ ${#missing_optional[@]} -gt 0 ]]; then
        echo -e "${CYAN}โน๏ธ  Optional packages available: ${missing_optional[*]}${RESET}"
        echo -en "${CYAN}Install optional packages? (y/N): ${RESET}"
        read -r response
        
        if [[ "$response" =~ ^[Yy]$ ]]; then
            install_packages "${missing_optional[@]}"
        fi
    fi
    
    echo -e "${GREEN}โ Dependency check complete${RESET}\n"
}

# Install packages based on package manager
install_packages() {
    local packages=("$@")
    
    case "$PACKAGE_MANAGER" in
        apt)
            sudo apt-get update -qq
            sudo apt-get install -y "${packages[@]}" 2>/dev/null || return 1
            ;;
        yum)
            sudo yum install -y "${packages[@]}" 2>/dev/null || return 1
            ;;
        dnf)
            sudo dnf install -y "${packages[@]}" 2>/dev/null || return 1
            ;;
        pacman)
            sudo pacman -S --noconfirm "${packages[@]}" 2>/dev/null || return 1
            ;;
        brew)
            brew install "${packages[@]}" 2>/dev/null || return 1
            ;;
        zypper)
            sudo zypper install -y "${packages[@]}" 2>/dev/null || return 1
            ;;
        *)
            return 1
            ;;
    esac
    
    return 0
}

# Show manual installation commands
show_install_commands() {
    local packages=("$@")
    
    case "$PACKAGE_MANAGER" in
        apt)
            echo "  sudo apt-get update"
            echo "  sudo apt-get install -y build-essential ${packages[*]} libpthread-stubs0-dev"
            ;;
        yum|dnf)
            echo "  sudo $PACKAGE_MANAGER groupinstall -y 'Development Tools'"
            echo "  sudo $PACKAGE_MANAGER install -y ${packages[*]}"
            ;;
        pacman)
            echo "  sudo pacman -S base-devel ${packages[*]}"
            ;;
        brew)
            echo "  brew install ${packages[*]}"
            ;;
        zypper)
            echo "  sudo zypper install -y -t pattern devel_basis"
            echo "  sudo zypper install -y ${packages[*]}"
            ;;
        *)
            echo "  Install: ${packages[*]}"
            ;;
    esac
}

# Create directory structure
setup_directories() {
    echo -e "${BOLD}${YELLOW}[2/9] Setting up directory structure...${RESET}"
    
    mkdir -p "${VATHYS_HOME}"/{bin,cache,config,logs,sessions,temp,backups}
    chmod 755 "${VATHYS_HOME}"
    chmod 700 "${VATHYS_HOME}/sessions"
    
    # Create subdirectories
    mkdir -p "${VATHYS_HOME}/cache"/{search,transfers}
    mkdir -p "${VATHYS_HOME}/logs"/{operations,transfers,errors}
    mkdir -p "${VATHYS_HOME}/sessions"/{ssh,saved}
    
    echo -e "${GREEN}โ Directory structure created${RESET}\n"
}

# Install main script
install_script() {
    echo -e "${BOLD}${YELLOW}[3/9] Installing VathysEye...${RESET}"
    
    local script_path=""
    if [[ -f "vathyseye" ]]; then
        script_path="vathyseye"
    elif [[ -f "src/vathyseye" ]]; then
        script_path="src/vathyseye"
    else
        echo -e "${RED}โ Cannot find vathyseye script${RESET}"
        exit 1
    fi
    
    if [[ -w "${INSTALL_DIR}" ]]; then
        cp "${script_path}" "${INSTALL_DIR}/vath"
        chmod +x "${INSTALL_DIR}/vath"
    else
        echo -e "${YELLOW}โ๏ธ  Need sudo for system-wide install${RESET}"
        sudo cp "${script_path}" "${INSTALL_DIR}/vath"
        sudo chmod +x "${INSTALL_DIR}/vath"
    fi
    
    if [[ -x "${INSTALL_DIR}/vath" ]]; then
        echo -e "${GREEN}โ VathysEye installed to ${INSTALL_DIR}/vath${RESET}\n"
    else
        echo -e "${RED}โ Installation failed${RESET}"
        exit 1
    fi
}

# Compile C helpers with optimizations
compile_helpers() {
    echo -e "${BOLD}${YELLOW}[4/9] Compiling performance engines...${RESET}"
    
    local gcc_flags="-O3 -pthread -march=native -mtune=native"
    
    if ! gcc ${gcc_flags} -x c - -o /dev/null 2>/dev/null <<< "int main(){return 0;}"; then
        echo -e "${YELLOW}โ๏ธ  Advanced optimizations not supported, using -O2${RESET}"
        gcc_flags="-O2 -pthread"
    fi
    
    echo -e "${CYAN}  Using GCC flags: ${gcc_flags}${RESET}"
    
    cat > "${VATHYS_HOME}/bin/test_compile.c" << 'TESTEOF'
#include <stdio.h>
#include <pthread.h>
int main() {
    printf("Compilation test successful\n");
    return 0;
}
TESTEOF
    
    if gcc ${gcc_flags} -o "${VATHYS_HOME}/bin/test_compile" "${VATHYS_HOME}/bin/test_compile.c" 2>/dev/null; then
        "${VATHYS_HOME}/bin/test_compile"
        rm -f "${VATHYS_HOME}/bin/test_compile" "${VATHYS_HOME}/bin/test_compile.c"
        echo -e "${GREEN}โ C compilation environment verified${RESET}"
        echo -e "${CYAN}  Engines will compile on first run${RESET}\n"
    else
        echo -e "${YELLOW}โ๏ธ  C compilation test failed, some features may be limited${RESET}\n"
    fi
}

# Create configuration files
create_config() {
    echo -e "${BOLD}${YELLOW}[5/9] Creating configuration files...${RESET}"
    
    local config_file="${VATHYS_HOME}/config/vathys.conf"
    
    if [[ ! -f "${config_file}" ]]; then
        cat > "${config_file}" << 'CONFEOF'
# VathysEye 5.1 Configuration File
# Generated during installation

#############################################################################
# SEARCH ENGINE SETTINGS
#############################################################################
DEFAULT_SEARCH_PATH="${HOME}"
MAX_SEARCH_RESULTS=100000
NUM_SEARCH_THREADS=16
ENABLE_FUZZY_SEARCH=true
SEARCH_QUEUE_SIZE=10000
CACHE_SEARCH_INDEX=true
INDEX_UPDATE_INTERVAL=3600

#############################################################################
# TRANSFER ENGINE SETTINGS
#############################################################################
NUM_TRANSFER_STREAMS=8
CHUNK_SIZE_MB=8
ENABLE_TRANSFER_RESUME=true
VERIFY_TRANSFERS=true
TRANSFER_TIMEOUT=300
MAX_RETRY_ATTEMPTS=3

#############################################################################
# MASS COPY SETTINGS (NEW in 5.1)
#############################################################################
USE_RSYNC_FOR_MASS_COPY=true
RSYNC_BANDWIDTH_LIMIT=0  # 0 = unlimited, or specify in KB/s
SHOW_MASS_COPY_PROGRESS=true
PRESERVE_PERMISSIONS=true
PRESERVE_TIMESTAMPS=true

#############################################################################
# AUTO-UPDATE SETTINGS (NEW in 5.1)
#############################################################################
AUTO_CHECK_UPDATES=false
UPDATE_CHECK_INTERVAL=7  # days
AUTO_BACKUP_BEFORE_UPDATE=true
UPDATE_CHANNEL="stable"  # stable or beta

#############################################################################
# COMPRESSION SETTINGS
#############################################################################
DEFAULT_COMPRESSION_FORMAT="tar.xz"
COMPRESSION_LEVEL=9
USE_PARALLEL_COMPRESSION=true
COMPRESSION_THREADS=4
TEMP_DIR="${VATHYS_HOME}/temp"

#############################################################################
# SSH/SFTP SETTINGS
#############################################################################
SSH_DEFAULT_PORT=22
SSH_CONNECTION_TIMEOUT=30
SSH_COMPRESSION=yes
SSH_CIPHER="aes128-gcm@openssh.com"
SSH_KEEP_ALIVE=60
SSH_MAX_SESSIONS=5
SSH_BATCH_MODE=no
SSH_STRICT_HOST_KEY_CHECKING=ask
SFTP_BUFFER_SIZE=32768

# SSH ControlMaster settings for connection reuse
SSH_CONTROL_MASTER=auto
SSH_CONTROL_PATH="${VATHYS_HOME}/sessions/ssh/%r@%h:%p"
SSH_CONTROL_PERSIST=600

#############################################################################
# DISPLAY SETTINGS
#############################################################################
COLOR_OUTPUT=true
SHOW_HIDDEN_FILES=false
EMOJI_INDICATORS=true
PROGRESS_BARS=true
VERBOSE_OUTPUT=false
SHOW_TRANSFER_STATS=true
DATE_FORMAT="%Y-%m-%d %H:%M:%S"

#############################################################################
# PERFORMANCE SETTINGS
#############################################################################
USE_C_HELPERS=true
CACHE_RESULTS=true
ENABLE_LOGGING=true
LOG_LEVEL=INFO
MAX_LOG_SIZE_MB=100
LOG_ROTATION=true

#############################################################################
# SECURITY SETTINGS
#############################################################################
SECURE_DELETE=false
VERIFY_CHECKSUMS=false
ENCRYPT_SESSIONS=false
AUTO_BACKUP_CONFIG=true
CONFEOF
        echo -e "${GREEN}โ Created configuration file${RESET}"
    else
        echo -e "${CYAN}โน๏ธ  Configuration file already exists${RESET}"
    fi
    
    # Create SSH config additions
    local ssh_config="${VATHYS_HOME}/config/ssh_config_additions"
    cat > "${ssh_config}" << 'SSHEOF'
# VathysEye SSH Configuration Additions
# Add these to your ~/.ssh/config for optimal performance

# Connection multiplexing for speed
ControlMaster auto
ControlPath ~/.vathyseye/sessions/ssh/%r@%h:%p
ControlPersist 600

# Compression and cipher selection
Compression yes
Ciphers aes128-gcm@openssh.com,aes256-gcm@openssh.com,chacha20-poly1305@openssh.com

# Keep connections alive
ServerAliveInterval 60
ServerAliveCountMax 3

# Performance tuning
TCPKeepAlive yes
IPQoS throughput

# Security
HashKnownHosts yes
StrictHostKeyChecking ask
SSHEOF
    
    echo -e "${CYAN}  SSH optimization config created${RESET}\n"
}

# Setup SSH environment
setup_ssh() {
    echo -e "${BOLD}${YELLOW}[6/9] Setting up SSH environment...${RESET}"
    
    mkdir -p "${VATHYS_HOME}/sessions/ssh"
    chmod 700 "${VATHYS_HOME}/sessions/ssh"
    
    if [[ ! -f ~/.ssh/id_rsa && ! -f ~/.ssh/id_ed25519 && ! -f ~/.ssh/id_ecdsa ]]; then
        echo -e "${YELLOW}โ๏ธ  No SSH key found${RESET}"
        echo -en "${CYAN}Generate SSH key now? (y/N): ${RESET}"
        read -r response
        
        if [[ "$response" =~ ^[Yy]$ ]]; then
            echo -e "${CYAN}Generating Ed25519 SSH key...${RESET}"
            ssh-keygen -t ed25519 -C "vathyseye@$(hostname)" -f ~/.ssh/id_ed25519
            
            if [[ -z "$SSH_AUTH_SOCK" ]]; then
                eval "$(ssh-agent -s)"
                ssh-add ~/.ssh/id_ed25519
            fi
            
            echo -e "${GREEN}โ SSH key generated${RESET}"
        fi
    else
        echo -e "${GREEN}โ SSH key found${RESET}"
    fi
    
    if [[ -f ~/.ssh/config ]]; then
        if ! grep -q "ControlMaster" ~/.ssh/config; then
            echo -en "${CYAN}Add SSH optimizations to ~/.ssh/config? (y/N): ${RESET}"
            read -r response
            
            if [[ "$response" =~ ^[Yy]$ ]]; then
                cat "${VATHYS_HOME}/config/ssh_config_additions" >> ~/.ssh/config
                echo -e "${GREEN}โ SSH config optimized${RESET}"
            fi
        fi
    fi
    
    echo ""
}

# Setup shell integration
setup_shell_integration() {
    echo -e "${BOLD}${YELLOW}[7/9] Setting up shell integration...${RESET}"
    
    local shell_rc=""
    local shell_name=""
    
    case "${SHELL}" in
        */bash)
            shell_rc="${HOME}/.bashrc"
            shell_name="Bash"
            ;;
        */zsh)
            shell_rc="${HOME}/.zshrc"
            shell_name="Zsh"
            ;;
        */fish)
            shell_rc="${HOME}/.config/fish/config.fish"
            shell_name="Fish"
            ;;
        *)
            echo -e "${YELLOW}โ๏ธ  Unknown shell (${SHELL}), skipping integration${RESET}\n"
            return
            ;;
    esac
    
    if [[ -n "${shell_rc}" && -f "${shell_rc}" ]]; then
        if ! grep -q "# VathysEye aliases" "${shell_rc}"; then
            echo -e "\n# VathysEye 5.1 aliases and functions" >> "${shell_rc}"
            echo "alias vath='vath'" >> "${shell_rc}"
            echo "alias vf='vath search'" >> "${shell_rc}"
            echo "alias vmc='vath mass-copy'" >> "${shell_rc}"
            echo "alias vx='vath extract'" >> "${shell_rc}"
            echo "alias vz='vath compress'" >> "${shell_rc}"
            echo "alias vi='vath -i'" >> "${shell_rc}"
            echo "alias vssh='vath ssh-connect'" >> "${shell_rc}"
            echo "alias vup='vath ssh-upload'" >> "${shell_rc}"
            echo "alias vdown='vath ssh-download'" >> "${shell_rc}"
            echo "alias vupdate='vath update'" >> "${shell_rc}"
            
            cat >> "${shell_rc}" << 'SHELLEOF'

# VathysEye bash completion
_vath_complete() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local commands="search copy mass-copy move rename delete compress extract ssh-connect ssh-upload ssh-download ssh-list update check-update interactive help"
    COMPREPLY=($(compgen -W "${commands}" -- ${cur}))
}
complete -F _vath_complete vath
SHELLEOF
            
            echo -e "${GREEN}โ Shell aliases added to ${shell_rc}${RESET}"
            echo -e "${CYAN}  Run: ${BOLD}source ${shell_rc}${RESET}"
        else
            echo -e "${CYAN}โน๏ธ  Shell integration already configured${RESET}"
        fi
    fi
    
    echo ""
}

# Create helper scripts
create_helper_scripts() {
    echo -e "${BOLD}${YELLOW}[8/9] Creating helper scripts...${RESET}"
    
    # Create benchmark script
    cat > "${VATHYS_HOME}/bin/vath-benchmark" << 'BENCHEOF'
#!/bin/bash
# VathysEye performance benchmark
echo "โก Running performance benchmarks..."
echo ""
echo "1. Search Performance Test"
time vath search "test" /usr 2>/dev/null | head -n 50
echo ""
echo "2. Transfer Performance Test (10MB file)"
dd if=/dev/zero of=/tmp/vath_test_10mb bs=1M count=10 2>/dev/null
time vath copy /tmp/vath_test_10mb /tmp/vath_test_10mb_copy
rm -f /tmp/vath_test_10mb /tmp/vath_test_10mb_copy
echo ""
echo "3. Mass Copy Test (with exclusion)"
mkdir -p /tmp/vath_test_src/{dir1,dir2,exclude_me}
touch /tmp/vath_test_src/dir{1,2}/test.txt
time vath mass-copy /tmp/vath_test_src /tmp/vath_test_dst exclude_me
rm -rf /tmp/vath_test_src /tmp/vath_test_dst
echo ""
echo "โ Benchmark complete"
BENCHEOF
    chmod +x "${VATHYS_HOME}/bin/vath-benchmark"
    
    # Create cleanup script
    cat > "${VATHYS_HOME}/bin/vath-cleanup" << 'CLEANEOF'
#!/bin/bash
# VathysEye cleanup script
echo "๐งน Cleaning VathysEye cache..."
rm -rf ~/.vathyseye/cache/*
rm -rf ~/.vathyseye/temp/*
rm -rf ~/.vathyseye/logs/*.log
echo "โ Cleanup complete"
CLEANEOF
    chmod +x "${VATHYS_HOME}/bin/vath-cleanup"
    
    echo -e "${GREEN}โ Helper scripts created:${RESET}"
    echo -e "${CYAN}  - vath-benchmark  Run performance tests${RESET}"
    echo -e "${CYAN}  - vath-cleanup    Clean cache and temp files${RESET}\n"
}

# Performance tuning
optimize_system() {
    echo -e "${BOLD}${YELLOW}[9/9] System Optimization${RESET}\n"
    
    echo -en "${CYAN}Apply system optimizations? (y/N): ${RESET}"
    read -r response
    
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        return
    fi
    
    if command -v ulimit >/dev/null 2>&1; then
        ulimit -n 65536 2>/dev/null && \
            echo -e "${GREEN}โ Increased file descriptor limit${RESET}" || \
            echo -e "${YELLOW}โ๏ธ  Could not increase file descriptor limit${RESET}"
    fi
    
    if [[ $EUID -eq 0 ]]; then
        sysctl -w net.core.rmem_max=134217728 2>/dev/null
        sysctl -w net.core.wmem_max=134217728 2>/dev/null
        sysctl -w net.ipv4.tcp_rmem="4096 87380 67108864" 2>/dev/null
        sysctl -w net.ipv4.tcp_wmem="4096 65536 67108864" 2>/dev/null
        echo -e "${GREEN}โ TCP settings optimized${RESET}"
    fi
    
    echo ""
}

# Final setup and verification
finalize() {
    echo -e "\n${BOLD}${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}"
    echo -e "${BOLD}${GREEN}โ                                                           โ${RESET}"
    echo -e "${BOLD}${GREEN}โ        Installation Complete! ๐                          โ${RESET}"
    echo -e "${BOLD}${GREEN}โ        VathysEye 5.1 is ready to use                      โ${RESET}"
    echo -e "${BOLD}${GREEN}โ                                                           โ${RESET}"
    echo -e "${BOLD}${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}\n"
    
    echo -e "${BOLD}${CYAN}๐ QUICK START:${RESET}"
    echo -e "${YELLOW}  vath${RESET}                          Launch interactive mode"
    echo -e "${YELLOW}  vath mass-copy /src /dst DIR${RESET}  Mass copy with exclusions"
    echo -e "${YELLOW}  vath update${RESET}                    Check and install updates"
    echo -e "${YELLOW}  vath help${RESET}                      Show full help\n"
    
    echo -e "${BOLD}${CYAN}โก SHELL ALIASES:${RESET} ${MAGENTA}(run: source ${shell_rc})${RESET}"
    echo -e "${YELLOW}  vmc${RESET} <src> <dst> [exclude]      Quick mass copy"
    echo -e "${YELLOW}  vf${RESET} <pattern>                   Quick file search"
    echo -e "${YELLOW}  vupdate${RESET}                        Quick update check"
    echo -e "${YELLOW}  vssh${RESET}                           Quick SSH connect\n"
    
    echo -e "${BOLD}${CYAN}๐ NEW FEATURES (v5.1):${RESET}"
    echo -e "  ${GREEN}โ${RESET} Mass copy with pattern-based exclusions"
    echo -e "  ${GREEN}โ${RESET} Auto-update system with GitHub integration"
    echo -e "  ${GREEN}โ${RESET} Enhanced rsync integration for speed"
    echo -e "  ${GREEN}โ${RESET} Improved configuration management\n"
    
    echo -e "${BOLD}${CYAN}๐ง HELPER SCRIPTS:${RESET}"
    echo -e "${YELLOW}  ${VATHYS_HOME}/bin/vath-benchmark${RESET}    Run benchmarks"
    echo -e "${YELLOW}  ${VATHYS_HOME}/bin/vath-cleanup${RESET}      Clean cache\n"
    
    echo -e "${BOLD}${CYAN}๐ DIRECTORIES:${RESET}"
    echo -e "${YELLOW}  Config:${RESET}   ${VATHYS_HOME}/config/vathys.conf"
    echo -e "${YELLOW}  Logs:${RESET}     ${VATHYS_HOME}/logs/"
    echo -e "${YELLOW}  SSH:${RESET}      ${VATHYS_HOME}/sessions/ssh/\n"
    
    echo -e "${BOLD}${CYAN}๐ป SYSTEM INFO:${RESET}"
    echo -e "  OS:        ${OS_TYPE}"
    echo -e "  Package:   ${PACKAGE_MANAGER}"
    echo -e "  GCC:       $(gcc --version 2>/dev/null | head -n1 | cut -d' ' -f3)"
    echo -e "  Threads:   $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 'unknown')"
    echo -e "  Version:   ${SCRIPT_VERSION}\n"
    
    echo -e "${BOLD}${YELLOW}โก VathysEye 5.1 - Mass Copy, Auto-Update, Blazing Fast! โก${RESET}\n"
    
    echo -e "${BOLD}${MAGENTA}๐ก TIPS:${RESET}"
    echo -e "  โข Run 'vath update' to check for updates"
    echo -e "  โข Use 'vmc' alias for quick mass copy operations"
    echo -e "  โข Configure SSH keys for password-less authentication"
    echo -e "  โข Adjust ${VATHYS_HOME}/config/vathys.conf to your needs\n"
}

# Main installation flow
main() {
    case "${1:-install}" in
        install)
            check_dependencies
            setup_directories
            install_script
            compile_helpers
            create_config
            setup_ssh
            setup_shell_integration
            create_helper_scripts
            optimize_system
            finalize
            ;;
        *)
            echo -e "${BOLD}${CYAN}VathysEye 5.1 Installation Script${RESET}\n"
            echo -e "${YELLOW}Usage:${RESET}"
            echo -e "  ./run [command]\n"
            echo -e "${YELLOW}Commands:${RESET}"
            echo -e "  ${CYAN}install${RESET}     Install VathysEye (default)"
            echo ""
            ;;
    esac
}

trap 'echo -e "\n${RED}โ Installation failed at line $LINENO${RESET}"; exit 1' ERR

main "$@"
